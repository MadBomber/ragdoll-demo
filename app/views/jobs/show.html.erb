<% content_for :title, "Job Details - Ragdoll Engine Demo" %>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="fas fa-tasks"></i> Job Details</h1>
      <%= link_to "Back to Jobs", jobs_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-info-circle"></i> Job Information</h5>
      </div>
      <div class="card-body">
        <table class="table table-borderless">
          <tr>
            <th style="width: 200px;">Job Class:</th>
            <td><code><%= @job.class_name %></code></td>
          </tr>
          <tr>
            <th>Job ID:</th>
            <td><%= @job.id %></td>
          </tr>
          <tr>
            <th>Queue:</th>
            <td><span class="badge bg-primary"><%= @job.queue_name %></span></td>
          </tr>
          <tr>
            <th>Priority:</th>
            <td><%= @job.priority %></td>
          </tr>
          <tr>
            <th>Created:</th>
            <td><%= @job.created_at.strftime("%Y-%m-%d %H:%M:%S") %> (<%= time_ago_in_words(@job.created_at) %> ago)</td>
          </tr>
          <% if @job.scheduled_at %>
          <tr>
            <th>Scheduled For:</th>
            <td><%= @job.scheduled_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
          </tr>
          <% end %>
          <% if @job.finished_at %>
          <tr>
            <th>Finished:</th>
            <td><%= @job.finished_at.strftime("%Y-%m-%d %H:%M:%S") %> (<%= time_ago_in_words(@job.finished_at) %> ago)</td>
          </tr>
          <tr>
            <th>Duration:</th>
            <td><%= number_with_precision((@job.finished_at - @job.created_at), precision: 2) %> seconds</td>
          </tr>
          <% end %>
          <tr>
            <th>Status:</th>
            <td>
              <% if @job.finished_at %>
                <span class="badge bg-success">Completed</span>
              <% else %>
                <span class="badge bg-warning">Pending</span>
              <% end %>
            </td>
          </tr>
        </table>
      </div>
    </div>
    
    <div class="card mt-4">
      <div class="card-header">
        <h5><i class="fas fa-code"></i> Job Arguments</h5>
      </div>
      <div class="card-body">
        <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@job.arguments) %></pre>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-tools"></i> Actions</h5>
      </div>
      <div class="card-body">
        <%= link_to jobs_path, class: "btn btn-primary w-100 mb-2" do %>
          <i class="fas fa-arrow-left"></i> Back to Jobs
        <% end %>
        
        <% unless @job.finished_at %>
          <%= form_with url: job_path(@job), method: :delete, local: true,
                      data: { confirm: "Are you sure you want to delete this pending job?" } do |form| %>
            <%= form.submit "Delete Job", class: "btn btn-danger w-100" %>
          <% end %>
        <% end %>
      </div>
    </div>
    
    <div class="card mt-4">
      <div class="card-header">
        <h5><i class="fas fa-chart-line"></i> Performance</h5>
      </div>
      <div class="card-body">
        <% if @job.finished_at && @job.created_at %>
          <p><strong>Execution Time:</strong><br>
          <%= number_with_precision((@job.finished_at - @job.created_at), precision: 3) %> seconds</p>
        <% end %>
        
        <p><strong>Queue Position:</strong><br>
        <% if @job.finished_at %>
          Completed
        <% else %>
          <% pending_before = SolidQueue::Job.where(queue_name: @job.queue_name, finished_at: nil).where("created_at < ?", @job.created_at).count %>
          <%= pending_before + 1 %> of <%= SolidQueue::Job.where(queue_name: @job.queue_name, finished_at: nil).count %>
        <% end %>
        </p>
      </div>
    </div>
  </div>
</div>