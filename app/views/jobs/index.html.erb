<% content_for :title, "Job Dashboard - Ragdoll Engine Demo" %>

<%= render PageHeaderComponent.new(
  title: "Job Dashboard",
  icon: "fas fa-tasks", 
  subtitle: "Monitor background job processing and queue status"
) %>

<div class="row mb-4">
  <div class="col-md-3">
    <%= render StatsCardComponent.new(
      title: "Pending",
      value: @stats[:pending],
      icon: "fas fa-clock",
      color: "warning",
      description: "Jobs waiting to process"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render StatsCardComponent.new(
      title: "Completed",
      value: @stats[:completed],
      icon: "fas fa-check-circle",
      color: "success",
      description: "Successfully completed"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render StatsCardComponent.new(
      title: "Failed",
      value: @stats[:failed],
      icon: "fas fa-exclamation-circle",
      color: "danger",
      description: "Jobs that failed"
    ) %>
  </div>
  <div class="col-md-3">
    <%= render StatsCardComponent.new(
      title: "Total",
      value: @stats[:total],
      icon: "fas fa-tasks",
      color: "info",
      description: "All jobs processed"
    ) %>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="pending-tab" data-bs-toggle="tab" href="#pending" role="tab">
              <i class="fas fa-clock"></i> Pending Jobs (<%= @stats[:pending] %>)
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="completed-tab" data-bs-toggle="tab" href="#completed" role="tab">
              <i class="fas fa-check-circle"></i> Completed Jobs (<%= @stats[:completed] %>)
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="failed-tab" data-bs-toggle="tab" href="#failed" role="tab">
              <i class="fas fa-exclamation-circle"></i> Failed Jobs (<%= @stats[:failed] %>)
            </a>
          </li>
        </ul>
      </div>
      <div class="card-body">
        <div class="tab-content">
          <!-- Pending Jobs Tab -->
          <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <% if @pending_jobs.any? %>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Job Class</th>
                      <th>Arguments</th>
                      <th>Queue</th>
                      <th>Created</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @pending_jobs.each do |job| %>
                      <tr>
                        <td>
                          <strong><%= job.class_name %></strong>
                        </td>
                        <td>
                          <small class="text-muted">
                            <%= truncate(job.arguments.to_s, length: 100) %>
                          </small>
                        </td>
                        <td>
                          <span class="badge bg-primary"><%= job.queue_name %></span>
                        </td>
                        <td>
                          <small><%= time_ago_in_words(job.created_at) %> ago</small>
                        </td>
                        <td>
                          <%= link_to "Details", job_path(job), class: "btn btn-sm btn-outline-info" %>
                          <%= form_with url: job_path(job), method: :delete, local: true,
                                      data: { confirm: "Are you sure?" },
                                      style: "display: inline;" do |form| %>
                            <%= form.submit "Delete", class: "btn btn-sm btn-outline-danger" %>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Pending Jobs</h5>
                <p class="text-muted">All jobs have been processed!</p>
              </div>
            <% end %>
          </div>
          
          <!-- Completed Jobs Tab -->
          <div class="tab-pane fade" id="completed" role="tabpanel">
            <% if @completed_jobs.any? %>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Job Class</th>
                      <th>Arguments</th>
                      <th>Queue</th>
                      <th>Completed</th>
                      <th>Duration</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @completed_jobs.each do |job| %>
                      <tr>
                        <td>
                          <strong><%= job.class_name %></strong>
                        </td>
                        <td>
                          <small class="text-muted">
                            <%= truncate(job.arguments.to_s, length: 100) %>
                          </small>
                        </td>
                        <td>
                          <span class="badge bg-success"><%= job.queue_name %></span>
                        </td>
                        <td>
                          <small><%= time_ago_in_words(job.finished_at) %> ago</small>
                        </td>
                        <td>
                          <% if job.finished_at && job.created_at %>
                            <small><%= number_with_precision((job.finished_at - job.created_at), precision: 2) %>s</small>
                          <% else %>
                            <small>-</small>
                          <% end %>
                        </td>
                        <td>
                          <%= link_to "Details", job_path(job), class: "btn btn-sm btn-outline-info" %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-history text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Completed Jobs</h5>
                <p class="text-muted">No jobs have been completed yet.</p>
              </div>
            <% end %>
          </div>
          
          <!-- Failed Jobs Tab -->
          <div class="tab-pane fade" id="failed" role="tabpanel">
            <% if @failed_jobs.any? %>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Job Class</th>
                      <th>Error</th>
                      <th>Failed At</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @failed_jobs.each do |failed_job| %>
                      <tr>
                        <td>
                          <strong><%= failed_job.job.class_name %></strong>
                        </td>
                        <td>
                          <small class="text-danger">
                            <%= truncate(failed_job.error.to_s, length: 150) %>
                          </small>
                        </td>
                        <td>
                          <small><%= time_ago_in_words(failed_job.created_at) %> ago</small>
                        </td>
                        <td>
                          <%= link_to "Retry", retry_job_path(failed_job), method: :post,
                                      class: "btn btn-sm btn-warning" %>
                          <%= form_with url: job_path(failed_job, type: 'failed'), method: :delete, local: true,
                                      data: { confirm: "Are you sure?" },
                                      style: "display: inline;" do |form| %>
                            <%= form.submit "Delete", class: "btn btn-sm btn-outline-danger" %>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-shield-alt text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Failed Jobs</h5>
                <p class="text-muted">All jobs are running smoothly!</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-info-circle"></i> Queue Information</h5>
      </div>
      <div class="card-body">
        <p><strong>Queue Adapter:</strong> SolidQueue</p>
        <p><strong>Default Queue:</strong> default</p>
        <p><strong>Auto-refresh:</strong> This page auto-refreshes every 30 seconds</p>
        <div class="mt-3">
          <%= link_to "Refresh Now", jobs_path, class: "btn btn-primary" %>
          <%= link_to "Back to Dashboard", dashboard_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-heartbeat"></i> Worker Health</h5>
      </div>
      <div class="card-body">
        <div id="worker-health-status">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Checking...</span>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <%= link_to "Check Health", health_jobs_path, 
                      class: "btn btn-info", 
                      id: "check-health-btn" %>
          <%= form_with url: restart_workers_jobs_path, method: :post, local: true, 
                      data: { confirm: "Are you sure you want to restart the workers?" }, 
                      style: "display: inline;" do |form| %>
            <%= form.submit "Restart Workers", class: "btn btn-warning", id: "restart-workers-btn" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Worker health checking
  function checkWorkerHealth() {
    fetch('/jobs/health')
      .then(response => response.json())
      .then(data => {
        updateHealthDisplay(data);
      })
      .catch(error => {
        console.error('Health check failed:', error);
        document.getElementById('worker-health-status').innerHTML = 
          '<div class="alert alert-danger">Health check failed</div>';
      });
  }
  
  function updateHealthDisplay(health) {
    const statusElement = document.getElementById('worker-health-status');
    const restartBtn = document.getElementById('restart-workers-btn');
    
    let statusHtml = '';
    let alertClass = '';
    
    switch(health.status) {
      case 'healthy':
        alertClass = 'alert-success';
        statusHtml = `
          <div class="alert ${alertClass}">
            <i class="fas fa-check-circle"></i> <strong>Healthy</strong><br>
            <small>${health.worker_count} workers running, ${health.stalled_jobs} pending jobs</small>
          </div>
        `;
        restartBtn.disabled = false;
        break;
        
      case 'stalled':
        alertClass = 'alert-warning';
        const oldestAge = Math.round(health.oldest_pending_job / 60);
        statusHtml = `
          <div class="alert ${alertClass}">
            <i class="fas fa-exclamation-triangle"></i> <strong>Stalled</strong><br>
            <small>${health.stalled_jobs} jobs pending for ${oldestAge}+ minutes</small>
          </div>
        `;
        restartBtn.disabled = false;
        restartBtn.classList.add('btn-danger');
        restartBtn.classList.remove('btn-warning');
        break;
        
      case 'no_workers':
        alertClass = 'alert-danger';
        statusHtml = `
          <div class="alert ${alertClass}">
            <i class="fas fa-times-circle"></i> <strong>No Workers</strong><br>
            <small>No worker processes detected</small>
          </div>
        `;
        restartBtn.disabled = false;
        restartBtn.classList.add('btn-danger');
        restartBtn.classList.remove('btn-warning');
        break;
        
      case 'processing':
        alertClass = 'alert-info';
        statusHtml = `
          <div class="alert ${alertClass}">
            <i class="fas fa-cog fa-spin"></i> <strong>Processing</strong><br>
            <small>${health.worker_count} workers, ${health.stalled_jobs} jobs in queue</small>
          </div>
        `;
        restartBtn.disabled = false;
        break;
    }
    
    statusElement.innerHTML = statusHtml;
  }
  
  // Check health on page load
  document.addEventListener('DOMContentLoaded', function() {
    checkWorkerHealth();
    
    // Check health every 15 seconds
    setInterval(checkWorkerHealth, 15000);
    
    // Manual health check button
    document.getElementById('check-health-btn').addEventListener('click', function(e) {
      e.preventDefault();
      checkWorkerHealth();
    });
  });
  
  // Auto-refresh page every 30 seconds
  setTimeout(function() {
    window.location.reload();
  }, 30000);
</script>