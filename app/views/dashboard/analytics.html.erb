<% content_for :title, "Analytics Dashboard - Ragdoll Engine Demo" %>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
        <p class="text-muted">Comprehensive analytics and insights for your Ragdoll engine</p>
      </div>
      <div class="d-flex gap-2">
        <%= link_to search_path, class: "btn btn-outline-primary" do %>
          <i class="fas fa-search"></i> Back to Search
        <% end %>
        <%= link_to dashboard_path, class: "btn btn-outline-secondary" do %>
          <i class="fas fa-home"></i> Dashboard
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Key Metrics Overview -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-primary h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-primary">
          <i class="fas fa-search"></i> Total Searches
        </h5>
        <h2 class="text-primary"><%= @search_analytics[:total_searches] %></h2>
        <small class="text-muted">All time searches</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-success h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-success">
          <i class="fas fa-question-circle"></i> Unique Queries
        </h5>
        <h2 class="text-success"><%= @search_analytics[:unique_queries] %></h2>
        <small class="text-muted">Distinct search terms</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-info h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-info">
          <i class="fas fa-calendar-week"></i> This Week
        </h5>
        <h2 class="text-info"><%= @search_analytics[:searches_this_week] %></h2>
        <small class="text-muted">Weekly search activity</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-warning h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-warning">
          <i class="fas fa-bullseye"></i> Avg Similarity
        </h5>
        <h2 class="text-warning"><%= @search_analytics[:average_similarity] %></h2>
        <small class="text-muted">Search relevance score</small>
      </div>
    </div>
  </div>
</div>

<!-- Time-based Analytics -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card border-secondary h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-secondary">
          <i class="fas fa-calendar-day"></i> Today
        </h5>
        <h2 class="text-secondary"><%= @search_analytics[:searches_today] %></h2>
        <small class="text-muted">Daily activity</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-dark h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-dark">
          <i class="fas fa-calendar-alt"></i> This Month
        </h5>
        <h2 class="text-dark"><%= @search_analytics[:searches_this_month] %></h2>
        <small class="text-muted">Monthly searches</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-muted h-100">
      <div class="card-body text-center">
        <h5 class="card-title text-muted">
          <i class="fas fa-chart-bar"></i> Avg Results
        </h5>
        <h2 class="text-muted"><%= @search_analytics[:average_results] %></h2>
        <small class="text-muted">Results per search</small>
      </div>
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5><i class="fas fa-chart-area"></i> Search Trends (7 Days)</h5>
      </div>
      <div class="card-body">
        <% if @search_trends.any? %>
          <canvas id="searchTrendsChart" width="400" height="200"></canvas>
        <% else %>
          <div class="text-center py-4">
            <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
            <p class="text-muted">No search trend data available yet.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5><i class="fas fa-bullseye"></i> Similarity Score Distribution</h5>
      </div>
      <div class="card-body">
        <% if @similarity_distribution && @similarity_distribution.values.any? { |v| v > 0 } %>
          <canvas id="similarityDistributionChart" width="400" height="200"></canvas>
          
          <!-- Fallback table display -->
          <div id="similarityFallback" class="d-none mt-3">
            <p class="text-muted mb-2">Chart display unavailable. Data table:</p>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Similarity Range</th>
                  <th>Number of Searches</th>
                </tr>
              </thead>
              <tbody>
                <% @similarity_distribution.each do |range, count| %>
                  <% if count > 0 %>
                    <tr>
                      <td><%= range %></td>
                      <td><span class="badge bg-info"><%= count %></span></td>
                    </tr>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
            <p class="text-muted">No similarity distribution data available yet.</p>
            <% if @similarity_distribution && @similarity_distribution.any? %>
              <small class="text-muted">
                Distribution: <%= @similarity_distribution.values.sum %> total searches with similarity scores
              </small>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Content Analytics -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5><i class="fas fa-star"></i> Top Search Queries</h5>
      </div>
      <div class="card-body">
        <% if @top_queries.any? %>
          <div class="query-list" style="max-height: 400px; overflow-y: auto;">
            <% @top_queries.each_with_index do |(query, count), index| %>
              <div class="d-flex justify-content-between align-items-center mb-2 p-2 <%= 'bg-light rounded' if index < 3 %>">
                <div class="flex-grow-1">
                  <span class="badge bg-<%= index == 0 ? 'warning' : index == 1 ? 'secondary' : index == 2 ? 'dark' : 'primary' %> me-2">
                    <i class="fas fa-<%= index == 0 ? 'crown' : index == 1 ? 'medal' : index == 2 ? 'award' : 'search' %>"></i>
                    <%= index + 1 %>
                  </span>
                  <strong><%= truncate(query, length: 50) %></strong>
                </div>
                <span class="badge bg-success ms-2"><%= count %> searches</span>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <p class="text-muted">No search queries recorded yet.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h5><i class="fas fa-fire"></i> Most Searched Documents</h5>
      </div>
      <div class="card-body">
        <% if @top_documents.any? %>
          <div class="document-list" style="max-height: 400px; overflow-y: auto;">
            <% @top_documents.each_with_index do |(document_title, count), index| %>
              <div class="d-flex justify-content-between align-items-center mb-2 p-2 <%= 'bg-light rounded' if index < 3 %>">
                <div class="flex-grow-1">
                  <span class="badge bg-<%= index == 0 ? 'warning' : index == 1 ? 'secondary' : index == 2 ? 'dark' : 'info' %> me-2">
                    <i class="fas fa-<%= index == 0 ? 'trophy' : index == 1 ? 'medal' : index == 2 ? 'award' : 'file-alt' %>"></i>
                    <%= index + 1 %>
                  </span>
                  <strong><%= truncate(document_title, length: 40) %></strong>
                </div>
                <span class="badge bg-success ms-2"><%= count %> hits</span>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="text-center py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted">No document usage data available yet.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Detailed Statistics -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-table"></i> Detailed System Analytics</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <h6 class="border-bottom pb-2"><i class="fas fa-search text-primary"></i> Search Performance</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td>Total Searches:</td>
                  <td><strong><%= @search_analytics[:total_searches] %></strong></td>
                </tr>
                <tr>
                  <td>Unique Queries:</td>
                  <td><strong><%= @search_analytics[:unique_queries] %></strong></td>
                </tr>
                <tr>
                  <td>Today:</td>
                  <td><strong><%= @search_analytics[:searches_today] %></strong></td>
                </tr>
                <tr>
                  <td>This Week:</td>
                  <td><strong><%= @search_analytics[:searches_this_week] %></strong></td>
                </tr>
                <tr>
                  <td>This Month:</td>
                  <td><strong><%= @search_analytics[:searches_this_month] %></strong></td>
                </tr>
                <tr>
                  <td>Avg Execution Time:</td>
                  <td><strong><%= @search_analytics[:avg_execution_time] %>ms</strong></td>
                </tr>
                <tr>
                  <td>Avg Results:</td>
                  <td><strong><%= @search_analytics[:average_results] %></strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="col-md-4">
            <h6 class="border-bottom pb-2"><i class="fas fa-bullseye text-success"></i> Search Quality</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td>Average Similarity:</td>
                  <td><strong><%= @search_analytics[:average_similarity] %></strong></td>
                </tr>
                <tr>
                  <td>High Quality (>0.8):</td>
                  <td><strong><%= (@similarity_distribution["0.9-1.0"] || 0) + (@similarity_distribution["0.8-0.9"] || 0) %></strong></td>
                </tr>
                <tr>
                  <td>Medium Quality (0.6-0.8):</td>
                  <td><strong><%= (@similarity_distribution["0.7-0.8"] || 0) + (@similarity_distribution["0.6-0.7"] || 0) %></strong></td>
                </tr>
                <tr>
                  <td>Low Quality (<0.6):</td>
                  <td><strong><%= (@similarity_distribution["0.5-0.6"] || 0) + (@similarity_distribution["< 0.5"] || 0) %></strong></td>
                </tr>
                <tr>
                  <td colspan="2"><strong>Search Types:</strong></td>
                </tr>
                <% @search_analytics[:search_types].each do |type, count| %>
                <tr>
                  <td class="ps-3"><%= type.titleize %>:</td>
                  <td><strong><%= count %></strong></td>
                </tr>
                <% end %>
              </tbody>
            </table>
          </div>
          
          <div class="col-md-4">
            <h6 class="border-bottom pb-2"><i class="fas fa-server text-info"></i> System Status</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <td>Total Documents:</td>
                  <td><strong><%= @system_stats[:total_documents] %></strong></td>
                </tr>
                <tr>
                  <td>Processed Documents:</td>
                  <td><strong class="text-success"><%= @system_stats[:processed_documents] %></strong></td>
                </tr>
                <tr>
                  <td>Failed Documents:</td>
                  <td><strong class="text-danger"><%= @system_stats[:failed_documents] %></strong></td>
                </tr>
                <tr>
                  <td>Pending Documents:</td>
                  <td><strong class="text-warning"><%= @system_stats[:pending_documents] %></strong></td>
                </tr>
                <tr>
                  <td>Total Embeddings:</td>
                  <td><strong><%= @system_stats[:total_embeddings] %></strong></td>
                </tr>
                <tr>
                  <td>Total Usage Count:</td>
                  <td><strong><%= @system_stats[:total_embedding_usage] %></strong></td>
                </tr>
                <tr>
                  <td>Most Popular Doc:</td>
                  <td><strong><%= @top_documents.first&.first ? truncate(@top_documents.first.first, length: 20) : "None" %></strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @search_trends.any? %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìä Initializing comprehensive analytics dashboard charts...');
  
  // Search Trends Chart
  try {
    const trendsCtx = document.getElementById('searchTrendsChart').getContext('2d');
    const searchTrendsChart = new Chart(trendsCtx, {
      type: 'line',
      data: {
        labels: <%= @search_trends.keys.map(&:to_s).to_json.html_safe %>,
        datasets: [{
          label: 'Daily Searches',
          data: <%= @search_trends.values.to_json.html_safe %>,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        },
        elements: {
          point: {
            radius: 4,
            hoverRadius: 6
          }
        }
      }
    });
    console.log('‚úÖ Search trends chart created successfully');
  } catch (error) {
    console.error('‚ùå Error creating search trends chart:', error);
  }

  <% if @similarity_distribution && @similarity_distribution.values.any? { |v| v > 0 } %>
  // Similarity Distribution Chart
  console.log('üéØ Creating similarity distribution chart with data:', <%= @similarity_distribution.values.to_json.html_safe %>);
  
  try {
    const similarityCtx = document.getElementById('similarityDistributionChart').getContext('2d');
    const similarityChart = new Chart(similarityCtx, {
      type: 'bar',
      data: {
        labels: <%= @similarity_distribution.keys.map(&:to_s).to_json.html_safe %>,
        datasets: [{
          label: 'Number of Searches',
          data: <%= @similarity_distribution.values.to_json.html_safe %>,
          backgroundColor: [
            'rgba(220, 53, 69, 0.6)',   // < 0.5 - Red
            'rgba(253, 126, 20, 0.6)',  // 0.5-0.6 - Orange  
            'rgba(255, 193, 7, 0.6)',   // 0.6-0.7 - Yellow
            'rgba(25, 135, 84, 0.6)',   // 0.7-0.8 - Green
            'rgba(13, 110, 253, 0.6)',  // 0.8-0.9 - Blue
            'rgba(111, 66, 193, 0.6)'   // 0.9-1.0 - Purple
          ],
          borderColor: [
            'rgba(220, 53, 69, 1)',
            'rgba(253, 126, 20, 1)', 
            'rgba(255, 193, 7, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(13, 110, 253, 1)',
            'rgba(111, 66, 193, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return 'Similarity Range: ' + context[0].label;
              },
              label: function(context) {
                return context.parsed.y + ' searches';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.1)'
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            title: {
              display: true,
              text: 'Similarity Score Range'
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
    console.log('‚úÖ Similarity distribution chart created successfully');
  } catch (error) {
    console.error('‚ùå Error creating similarity distribution chart:', error);
    // Show fallback table
    const fallback = document.getElementById('similarityFallback');
    if (fallback) {
      fallback.classList.remove('d-none');
    }
    
    // Hide the canvas
    const canvas = document.getElementById('similarityDistributionChart');
    if (canvas) {
      canvas.style.display = 'none';
    }
  }
  <% end %>
  
  console.log('üöÄ Analytics dashboard initialization complete');
});
</script>
<% end %>